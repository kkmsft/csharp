# Cache and Informers

The cache and informer modules in C# is built to resemble the client-go implementation as much as possible.

The shared informer (`ISharedInfromer`) runs a **Controller** (`IController`), which initiates the **Reflector** (`IReflector`) module. 
**Reflector** runs a combination of list and watch (`ListWatcher`) on the API server endpoint to keep track of objects and changes 
to them. **Reflector** posts these events to a Queue and raises an event notifying the subscribers via an `AutoReset` event. 
**Controller** code keeps track of the Queue via the aforementioned event and extracts the objects from it. These objects are 
converted to `IKubernetesObject` and placed into a **Store** (`IStore`) which posts this into a thread safe store (`IThreadSafeStore`). 
The **Controller** also calls into resource handler callbacks registered via the **SharedInformer** by the user.

         Server                                               Client
         ------                                               ------ 

                                |   ~~~~~~~~~~~~~             ____________       _______       ___________________
                                |  | Resource   |            |            |     |       |     |                   | 
                                |  | Handler    |<-----------| Controller |---->| Store |---->| Thread safe store |
                                |  | callbacks  |            |____________|     |_______|     |___________________|
                                |   `````````````                  | 
                                |                              ____|______
                                |                             /   FIFO   /
                                |                            /__________/
                                |                                  ^
    _____________               |        ______________            |
    |            |              |        |             |           |
    | API server |------(list/watch)---->| Reflector   |-----------+
    |____________|              |        |_____________|
                        

## Implementation

### Code organization
The `IStore` interface/implementation and `IThreadSafeStore` interface/implementation are present in the **Cache** directory.
The `ISharedInformer`, `IController` and `IReflector` are in the **Informers** directory. The example usage is present 
in the `examples/informers` directory.

### Notes
A new generic `List` implementation has been added in `IKubernetes.List.cs`/`Kubernetes.List.cs`. In-order to construct the 
string to be used for List/Watch, we need to know the KubeApiVersion and the KubeKind for each object. A set of 
properties have been added via `ModelExtensions.cs.template` and generated by running the WatchGenerator code in `gen` 
directory.

## TODO:

- [ ] More code cleanup.
- [ ] Re-sync the list/watch as per resync period, starting the watch from last resource version.
- [ ] Add UT and E2E.
- [ ] Add shared informers for known types - Pod, Namespace etc. by means of generated calls.
- [ ] Shared informer factory.
- [ ] Add more parameters to Generic list call.
- [ ] Find better way that reflection to extract "Items" from the list type.
- [ ] Find better way than reflection to extract KubeVersion and KubeKind.